TRUNCATE TABLE authors CASCADE;
INSERT INTO authors (author_id, full_name, pen_name, birth_date) VALUES
  (1, 'Харпер Ли', NULL, '1926-04-28'),
  (2, 'Джордж Оруэлл', 'Эрик Артур Блэр', '1903-06-25'),
  (3, 'Дж. Р. Р. Толкин', NULL, '1892-01-03'),
  (4, 'Джейн Остин', NULL, '1775-12-16'),
  (5, 'Фрэнсис Скотт Фицджеральд', NULL, '1896-09-24'),
  (6, 'Эрнест Хемингуэй', NULL, '1899-07-21'),
  (7, 'Джозеф Хеллер', NULL, '1923-05-01'),
  (8, 'Герман Мелвилл', NULL, '1819-08-01'),
  (9, 'Джером Д. Сэлинджер', NULL, '1919-01-01'),
  (10, 'Габриэль Гарсиа Маркес', NULL, '1927-03-06'),
  (11, 'Рэй Брэдбери', NULL, '1920-08-22'),
  (12, 'Айн Рэнд', 'Алиса Розенбаум', '1905-02-02'),
  (13, 'Фрэнк Герберт', NULL, '1920-10-08'),
  (14, 'Курт Воннегут', NULL, '1922-11-11'),
  (15, 'Кен Кизи', NULL, '1935-09-07'),
  (16, 'Евгений Замятин', NULL, '1884-01-01'),
  (17, 'Альбер Камю', NULL, '1913-11-07'),
  (18, 'Михаил Булгаков', NULL, '1891-05-15'),
  (19, 'Федор Достоевский', NULL, '1821-11-11'),
  (20, 'Лев Толстой', NULL, '1828-09-09'),
  (21, 'Иван Гончаров', NULL, '1812-06-18'),
  (22, 'Иван Тургенев', NULL, '1818-11-09'),
  (23, 'Михаил Лермонтов', NULL, '1814-10-03'),
  (24, 'Александр Пушкин', NULL, '1799-06-06'),
  (25, 'Николай Гоголь', NULL, '1809-03-31');

TRUNCATE TABLE books CASCADE;
INSERT INTO books (ISBN, title, description) VALUES
  (9780062420701, 'Убить пересмешника', 'Роман, исследующий темы расизма и справедливости в американском Юге.'),
  (9780451524935, '1984', 'Антиутопический роман, критикующий тоталитаризм и слежку.'),
  (9780395082560, 'Властелин колец', 'Эпическое фэнтези, повествующее о борьбе за уничтожение Единого Кольца.'),
  (9780395071228, 'Хоббит, или Туда и обратно', 'Фэнтези-приключение, повествующее о путешествии хоббита Бильбо Бэггинса.'),
  (9781853260321, 'Гордость и предубеждение', 'Романтический роман, исследующий социальные нормы и отношения между мужчинами и женщинами.'),
  (9780743273565, 'Великий Гэтсби', 'Трагическая история любви, денег и американской мечты.'),
  (9780684801280, 'По ком звонит колокол', 'Роман о войне и дружбе, действие которого происходит во время гражданской войны в Испании.'),
  (9780684806127, 'Уловка-22', 'Сатирический роман о Второй мировой войне, исследующий абсурдность войны.'),
  (9781851242532, 'Моби Дик', 'Эпический роман о китобойном судне и его капитане, одержимом местью.'),
  (9780316769174, 'Над пропастью во ржи', 'Роман о подростковом бунте и взрослении.'),
  (9780307950883, 'Сто лет одиночества', 'Эпический роман о нескольких поколениях семьи, живущих в вымышленном городе Макондо.'),
  (9780380973274, '451 градус по Фаренгейту', 'Антиутопический роман о мире, в котором книги запрещены.'),
  (9780451528025, 'Атлант расправил плечи', 'Философский роман, проповедующий идеи индивидуализма и капитализма.'),
  (9780441172710, 'Дюна', 'Научно-фантастический роман о пустынной планете Арракис и борьбе за контроль над ее ценным ресурсом.'),
  (9780385333864, 'Бойня номер пять, или Крестовый поход детей', 'Научно-фантастический роман о солдате, путешествующем во времени и переживающем бомбардировку Дрездена во время Второй мировой войны.'),
  (9780451523403, 'Пролетая над гнездом кукушки', 'Роман о пациентах психиатрической больницы и их борьбе с властью.'),
  (9780486437880, 'Мы', 'Антиутопический роман о тоталитарном государстве, управляемом Единым Государством.'),
  (9780679720201, 'Посторонний', 'Философский роман об абсурдности жизни и экзистенциальном отчуждении.'),
  (9780380973108, 'Мастер и Маргарита', 'Сатирический роман о дьяволе, посещающем Москву, и событиях, которые за этим следуют.'),
  (9780486437963, 'Преступление и наказание', 'Психологический роман о студенте, который убивает старуху-ростовщицу, чтобы проверить свою теорию о том, что он выше морали.'),
  (9780486437932, 'Братья Карамазовы', 'Философский роман о четырех братьях Карамазовых и их взаимоотношениях с отцом.'),
  (9780486437969, 'Анна Каренина', 'Роман о несчастном браке и внебрачной связи.'),(9780307271136, 'Война и мир', 'Эпический роман о наполеоновских войнах и их влиянии на российское общество.'),
  (9780486439294, 'Идиот', 'Роман о князе Мышкине, человеке с добрым сердцем и наивной верой в человеческую природу.'),
  (9780486439195, 'Обломов', 'Роман о ленивом помещике Илье Ильиче Обломове.'),
  (9780486442417, 'Отцы и дети', 'Роман о конфликте поколений между молодым нигилистом Евгением Базаровым и старыми аристократами.'),
  (9780486441960, 'Герой нашего времени', 'Роман о молодом офицере Григории Печорине и его поиске смысла жизни.'),
  (9780486440925, 'Евгений Онегин', 'Роман в стихах о молодом дворянине Евгении Онегине и его отношениях с окружающими.'),
  (9780486440780, 'Ревизор', 'Комедия о коррумпированных чиновниках в небольшом российском городе.'),
  (9780486439652, 'Мертвые души', 'Сатирический роман о помещике Чичикове, который покупает мертвые души крепостных, чтобы получить государственные кредиты.');

TRUNCATE TABLE authors_books CASCADE;
INSERT INTO authors_books (author_id, ISBN) VALUES
  (1, 9780062420701),
  (2, 9780451524935),
  (3, 9780395082560),
  (3, 9780395071228),
  (4, 9781853260321),
  (5, 9780743273565),
  (6, 9780684801280),
  (7, 9780684806127),
  (8, 9781851242532),
  (9, 9780316769174),
  (10, 9780307950883),
  (11, 9780380973274),
  (12, 9780451528025),
  (13, 9780441172710),
  (14, 9780385333864),
  (15, 9780451523403),
  (16, 9780486437880),
  (17, 9780679720201),
  (18, 9780380973108),
  (19, 9780486437963),
  (19, 9780486437932),
  (19, 9780486439294),
  (19, 9780486439195),
  (20, 9780486437969),
  (21, 9780486439195),
  (22, 9780486442417),
  (23, 9780486441960),
  (24, 9780486440925),
  (25, 9780486440780),
  (25, 9780486439652);

TRUNCATE TABLE copies CASCADE;
INSERT INTO copies (copy_id, date_published, publish_country, ISBN) VALUES
  (1, '2020-07-15', 'США', 9780062420701),
  (2, '2019-09-23', 'Великобритания', 9780451524935),
  (3, '2017-10-25', 'США', 9780395082560),
  (4, '2016-11-08', 'Великобритания', 9780395071228),
  (5, '2015-12-15', 'США', 9781853260321),
  (6, '2014-01-23', 'США', 9780743273565),
  (7, '2013-02-12', 'Испания', 9780684801280),
  (8, '2012-03-29', 'США', 9780684806127),
  (9, '2011-04-19', 'Великобритания', 9781851242532),
  (10, '2010-05-28', 'США', 9780316769174),
  (11, '2009-06-16', 'Колумбия', 9780307950883),
  (12, '2008-07-24', 'США', 9780380973274),
  (13, '2007-08-13', 'США', 9780451528025),
  (14, '2006-09-22', 'США', 9780441172710),
  (15, '2005-10-31', 'США', 9780385333864),
  (16, '2004-11-19', 'США', 9780451523403),
  (17, '2003-12-28', 'Россия', 9780486437880),
  (18, '2002-01-16', 'Франция', 9780679720201),
  (19, '2001-02-25', 'Россия', 9780380973108),
  (20, '2000-03-14', 'Россия', 9780486437963),
  (21, '1999-04-23', 'Россия', 9780486437932),
  (22, '1998-05-12', 'Россия', 9780486437969),
  (23, '1997-06-21', 'Россия', 9780307271136),
  (24, '1996-07-30', 'Россия', 9780486439294),
  (25, '1995-08-18', 'Россия', 9780486439195),
  (26, '1994-09-27', 'Россия', 9780486442417),
  (27, '1993-10-16', 'Россия', 9780486441960),
  (28, '1992-11-25', 'Россия', 9780486440925),
  (29, '1991-12-14', 'Россия', 9780486440780),
  (30, '1990-01-23', 'Россия', 9780486439652),
  (31, '2001-02-25', 'Россия', 9780380973108),
  (32, '1994-09-27', 'Россия', 9780486442417),
  (33, '2000-03-14', 'Россия', 9780486437963),
  (34, '2000-03-14', 'Россия', 9780486437963),
  (35, '2012-03-29', 'США', 9780684806127);

TRUNCATE TABLE readers CASCADE;
INSERT INTO readers (reader_id, full_name, phone_number, address) VALUES
  (1, 'Иванов Иван Иванович', '8(916)123-45-67', 'г. Москва, ул. Ленина, д. 1, кв. 1'),
  (2, 'Петров Петр Петрович', '8(915)234-56-78', 'г. Санкт-Петербург, ул. Садовая, д. 2, кв. 2'),
  (3, 'Владимиров Владимир Владимирович', '8(917)345-67-89', 'г. Новосибирск, ул. Советская, д. 3, кв. 3'),
  (4, 'Иванова Мария Ивановна', '8(918)456-78-90', 'г. Екатеринбург, ул. Кирова, д. 4, кв. 4'),
  (5, 'Петрова Анна Петровна', '8(919)567-89-01', 'г. Нижний Новгород, ул. Горького, д. 5, кв. 5'),
  (6, 'Васильев Василий Васильевич', '8(920)678-90-12', 'г. Казань, ул. Баумана, д. 6, кв. 6'),
  (7, 'Сергеева Екатерина Сергеевна', '8(921)789-01-23', 'г. Челябинск, ул. Ленина, д. 7, кв. 7'),
  (8, 'Михайлов Михаил Михайлович', '8(922)890-12-34', 'г. Омск, ул. Пушкина, д. 8, кв. 8'),
  (9, 'Александрова Ольга Александровна', '8(923)901-23-45', 'г. Ростов-на-Дону, ул. Чехова, д. 9, кв. 9'),
  (10, 'Николаев Николай Николаевич', '8(924)012-34-56', 'г. Уфа, ул. Октябрьская, д. 10, кв. 10'),
  (11, 'Владимирова Елена Владимировна', '8(925)123-45-67', 'г. Пермь, ул. Ленина, д. 11, кв. 11'),
  (12, 'Игорев Игорь Игоревич', '8(926)234-56-78', 'г. Воронеж, ул. Плехановская, д. 12, кв. 12'),
  (13, 'Анатольева Ирина Анатольевна', '8(927)345-67-89', 'г. Красноярск, ул. Мира, д. 13, кв. 13'),
  (14, 'Дмитриев Дмитрий Дмитриевич', '8(928)456-78-90', 'г. Самара, ул. Куйбышева, д. 14, кв. 14'),
  (15, 'Сергеева Анна Сергеевна', '8(929)567-89-01', 'г. Саратов, ул. Московская, д. 15, кв. 15');

INSERT INTO reviews (review_id, ISBN, reader_id, text, rating, date) VALUES
  (1, 9780062420701, 1, 'Отличная книга! Очень интересная и захватывающая. Читается легко и быстро. Рекомендую всем любителям классической литературы.', 5, '2023-02-28'),
  (2, 9780451524935, 2, 'Книга понравилась, но не более. Сюжет интересный, но автор слишком много времени уделяет описаниям природы и быта. Из-за этого читать немного скучновато.', 4, '2023-03-07'),
  (3, 9780395082560, 3, 'Очень крутая книга! Я большой поклонник фэнтези, и эта книга стала одной из моих любимых. Сюжет захватывающий, персонажи хорошо прописаны, а мир продуман до мелочей.', 5, '2023-03-16'),
  (4, 9780395071228, 4, 'Книга хорошая, но не более. Сюжет интересный, но автор слишком много времени уделяет описаниям природы и быта. Из-за этого читать немного скучновато.', 4, '2023-03-25'),
  (5, 9781853260321, 5, 'Отличная книга! Очень интересная и захватывающая. Читается легко и быстро. Рекомендую всем любителям классической литературы.', 5, '2023-04-03'),
  (6, 9780743273565, 6, 'Книга понравилась, но не более. Сюжет интересный, но автор слишком много времени уделяет описаниям природы и быта. Из-за этого читать немного скучновато.', 4, '2023-04-12'),
  (7, 9780684801280, 7, 'Очень крутая книга! Я большой поклонник фэнтези, и эта книга стала одной из моих любимых. Сюжет захватывающий, персонажи хорошо прописаны, а мир продуман до мелочей. Буду советовать знакомым.', 5, '2023-04-21'),
  (8, 9780684806127, 8, 'Книга хорошая, но не более. Сюжет интересный, но автор слишком много времени уделяет описаниям природы и быта. Из-за этого читать немного скучновато.', 4, '2023-05-02'),
  (9, 9781851242532, 9, 'Отличная книга! Очень интересная и захватывающая. Читается легко и быстро. Рекомендую всем любителям классической литературы.', 5, '2023-05-11'),
  (10, 9780316769174, 10, 'Книга понравилась, но не более. Сюжет интересный, но автор слишком много времени уделяет описаниям природы и быта. Из-за этого читать немного скучновато.', 4, '2023-05-20'),
  (11, 9780307950883, 11, 'Очень крутая книга! Я большой поклонник фэнтези, и эта книга стала одной из моих любимых. Сюжет захватывающий, персонажи хорошо прописаны, а мир продуман до мелочей. Обязательно возьму снова, чтобы перечитать!', 5, '2023-05-29'),
  (12, 9780380973274, 12, 'Книга хорошая, но не более. Сюжет интересный, но автор слишком много времени уделяет описаниям природы и быта. Из-за этого читать немного скучновато.', 4, '2023-06-07'),(13, 9780451528025, 13, 'Отличная книга! Очень интересная и захватывающая. Читается легко и быстро. Рекомендую всем любителям классической литературы.', 5, '2023-06-16'),
  (14, 9780441172710, 14, 'Книга понравилась, но не более. Сюжет интересный, но автор слишком много времени уделяет описаниям природы и быта. Из-за этого читать немного скучновато.', 4, '2023-06-25'),
  (15, 9780385333864, 14, 'Очень крутая книга! Я большой поклонник фэнтези, и эта книга стала одной из моих любимых. Сюжет захватывающий, персонажи хорошо прописаны, а мир продуман до мелочей.', 5, '2023-07-04');

TRUNCATE TABLE borrowing CASCADE;
INSERT INTO borrowing (borrowing_id, start_date, end_date, copy_id, reader_id) VALUES
  (1, '2023-02-28', '2023-03-14', 1, 1),
  (2, '2023-03-07', '2023-03-21', 2, 2),
  (3, '2023-03-16', '2023-04-04', 3, 3),
  (4, '2023-03-25', '2023-04-11', 4, 4),
  (5, '2023-04-03', '2023-04-18', 5, 5),
  (6, '2023-04-12', '2023-04-28', 6, 6),
  (7, '2023-04-21', '2023-05-09', 7, 7),
  (8, '2023-05-02', '2023-05-18', 8, 8),
  (9, '2023-05-11', '2023-05-26', 9, 9),
  (10, '2023-05-20', '2023-06-05', 10, 10),
  (11, '2023-05-29', '2023-06-14', 11, 11),
  (12, '2023-06-07', '2023-06-23', 12, 12),
  (13, '2023-06-16', '2023-07-02', 13, 13),
  (14, '2023-06-25', '2023-07-11', 14, 14),
  (15, '2023-07-04', '2023-07-20', 15, 15);

TRUNCATE TABLE book_statuses CASCADE;
INSERT INTO book_statuses (ISBN, date, available, borrowed, next_return_date)
SELECT
  b.ISBN,
  '2023-03-25' AS date,
  COUNT(c.copy_id) FILTER (WHERE bb.borrowing_id IS NULL) AS available,
  COUNT(bb.borrowing_id) AS borrowed,
  MIN(bb.end_date) FILTER (WHERE bb.borrowing_id IS NOT NULL AND bb.end_date > '2023-03-25') AS next_return_date
FROM books b
LEFT JOIN copies c ON b.ISBN = c.ISBN
LEFT JOIN borrowing bb ON c.copy_id = bb.copy_id AND bb.start_date <= '2023-03-25' AND bb.end_date >= '2023-03-25'
GROUP BY b.ISBN;